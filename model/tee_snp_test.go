package model

import (
	"encoding/hex"
	"testing"

	"github.com/google/go-sev-guest/proto/sevsnp"
	"github.com/google/go-sev-guest/verify"
	"github.com/pkg/errors"
	"google.golang.org/protobuf/proto"
)

var SnpReport = "0afc0708031880800c2210000000000000000000000000000000002a1000000000000000000000000000000000380140848080808080808cd50148255a406171684f88d75774e9a98365728cf27540907b893e8c3846d385f69e1e6e7b72c5d60b5cc6ec243f15f12df701a95334c5278a1500a5a1c2187da1861e2de10a6230465c9cac27eb6400b95f599042777274010dd53b29c829fdc420ad1b6e964c14094fe39f166103c740cea875ec2de1086a20160be32297e31abec6b08393e2fe96bdfeddbaa435656ea5370c3dc28b8f0b0072300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007a3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082012045f0104c6b0be1ddad31cc9a283aee1e77cd096a02c72aafbe1db6bc1c98fd0c8a0120ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9001848080808080c08bd5019a014098cf00e84a626091cae5146b45fe91e43ed93d6c8cd47732939eeec7eeef92e3041eb3613e231f7ae0cd0f8ae55e5e79c77251a577ac0012fd15ffb918fcefc7a001848080808080808cd501a8011db00137b80101c0011dc80137d00101d801848080808080808cd501e20180046b16d317450a2f44bbe24eb5329c4b6abaa74af398b0a16a1d2f9afa10f7a9d43e7b2fe4217fe4b22ba5d0b0eea6f450000000000000000000000000000000000000000000000000cf5889ec28292ae5e42c78ad44c792afbbcac174b357297e0652c11b86f75550a3f2f08056fb14a2d1829480c11747c20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e801919e800512001a021a00"

func TestSnpVerify(t *testing.T) {
	reportBytes, err := hex.DecodeString(SnpReport)
	if err != nil {
		t.Fatal(err)
	}

	// 解析报告
	attestation := new(sevsnp.Attestation)
	err = proto.Unmarshal(reportBytes, attestation)
	if err != nil {
		t.Fatal(err)
	}

	options := verify.DefaultOptions()
	if err = verify.SnpAttestation(attestation, options); err != nil {
		t.Fatal(errors.Wrap(err, "verify.SnpAttestation"))
	}

}
